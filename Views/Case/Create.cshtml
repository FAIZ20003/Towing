@model Proffessional.Models.TowingCase
@{
    ViewData["Title"] = "Create Towing Case";
}

<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>@ViewData["Title"]</title>

    <style>
        /* ===== RESET ===== */
        * {
            box-sizing: border-box;
        }

        html, body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: #f3f4f6;
            color: #111827;
        }

        /* ===== LAYOUT ===== */
        .app {
            display: flex;
            height: 100vh;
        }

        /* ===== SIDEBAR ===== */
        .sidebar {
            width: 240px;
            min-width: 240px;
            background: #1f2937;
            color: #e5e7eb;
            display: flex;
            flex-direction: column;
        }

            .sidebar .logo {
                height: 60px;
                display: flex;
                align-items: center;
                padding: 0 20px;
                font-weight: 700;
                font-size: 18px;
                background: #111827;
            }

            .sidebar nav a {
                display: block;
                padding: 12px 20px;
                color: #d1d5db;
                text-decoration: none;
                font-size: 14px;
            }

                .sidebar nav a:hover {
                    background: #374151;
                    color: #fff;
                }

                .sidebar nav a.active {
                    background: #2563eb;
                    color: #fff;
                }

        /* ===== MAIN ===== */
        .main {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        /* ===== HEADER ===== */
        .header {
            height: 60px;
            background: #ffffff;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
        }

            .header input {
                width: 260px;
                padding: 7px 10px;
                border: 1px solid #d1d5db;
                border-radius: 6px;
            }

            .header .right {
                font-size: 14px;
                color: #374151;
            }

        select {
            width: 100%;
            padding: 8px 10px;
            border-radius: 6px;
            border: 1px solid #d1d5db;
            background-color: #ffffff;
            margin-top: 4px;
            font-size: 14px;
            color: #111827;
        }

            select:focus {
                outline: none;
                border-color: #2563eb;
            }

        /* ===== CONTENT ===== */
        .content {
            padding: 24px;
            overflow-y: auto;
        }

        .page-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 16px;
        }

        /* ===== FORM BOX ===== */
        .box {
            background: #ffffff;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .box-header {
            padding: 12px 16px;
            border-bottom: 1px solid #e5e7eb;
            font-weight: 600;
            background: #f9fafb;
        }

        .box-body {
            padding: 16px;
        }

        label {
            font-size: 13px;
            font-weight: 600;
            color: #374151;
            margin-top: 10px;
            display: block;
        }

        input, textarea {
            width: 100%;
            padding: 8px 10px;
            border-radius: 6px;
            border: 1px solid #d1d5db;
            margin-top: 4px;
        }

            input:focus, textarea:focus {
                outline: none;
                border-color: #2563eb;
            }

        /* ===== BUTTONS ===== */
        .actions {
            margin-top: 16px;
            display: flex;
            gap: 10px;
        }

        .btn-primary {
            background: #2563eb;
            border: none;
            color: #fff;
            padding: 8px 14px;
            border-radius: 6px;
            cursor: pointer;
        }

        .btn-secondary {
            background: #e5e7eb;
            border: none;
            padding: 8px 14px;
            border-radius: 6px;
            cursor: pointer;
        }
    </style>
</head>

<body>

    <div class="app">

        <!-- SIDEBAR -->
        <aside class="sidebar">
            <div class="logo">🚚 Towing</div>
            <nav>
                <a href="/Dashboard/Index">Dashboard</a>
                <a class="active">Create Case</a>
                <a href="/Case/List">Case List</a>
                <a href="/Staff/List">Staff</a>
                <a href="/Settings">Settings</a>
            </nav>
        </aside>

        <!-- MAIN -->
        <div class="main">

            <!-- HEADER --> 
            <div class="header">
                <div class="page-title">Create Towing Case</div>
              </div> 

            <!-- CONTENT -->
            <div class="content">

    

                <!-- MESSAGE PARSER -->
                <div class="box">
                    <div class="box-header">Case Message</div>
                    <div class="box-body">
                        <textarea id="rawMessage" rows="4"
                                  placeholder="Paste WhatsApp or email message here..."></textarea>

                        <div class="actions">
                            <button class="btn-secondary" onclick="parseMessage()">Parse Message</button>
                            <button type="button" class="btn-secondary" onclick="clearParser()">
                                🧹 Clear Message
                            </button>
                        </div>
                    </div>
                </div>

                <!-- CASE FORM -->
                <div class="box">
                    <div class="box-header">Case Details</div>
                    <div class="box-body">

                        <form id="caseForm">

                            <label>Case ID *</label>
                            <input id="CaseId" name="CaseId" required />

                            <label>Customer Name</label>
                            <input id="CustomerName" name="CustomerName" />

                            <label>Vehicle Brand</label>
                            <input id="VehicleBrand" name="VehicleBrand" />

                            <label>Model</label>
                            <input id="Model" name="Model" />

                            <label>Registration No</label>
                            <input id="RegistrationNo" name="RegistrationNo" />

                            <label>Chassis No</label>
                            <input id="ChassisNo" name="ChassisNo" />

                            <label>Contact Number</label>
                            <input id="CustomerContactNumber" name="CustomerContactNumber" />

                            <label>Incident Reason</label>
                            <input id="IncidentReason" name="IncidentReason" />

                            <label>Assigned Vendor Name</label>
                            <input type="text" name="AssignedVendorName" id="AssignedVendorName" />

                            <label>Vendor Contact Number</label>
                            <input type="text" name="VendorContactNumber" id="VendorContactNumber" />

                            <label>Towing Type</label>
                            <select id="TowingType" name="TowingType">
                                <option value="">-- Select Towing Type --</option>
                                <option value="Breakdown">Breakdown</option>
                                <option value="Accident">Accident</option>
                                <option value="Flat Tyre">Flat Tyre</option>
                                <option value="Battery Issue">Battery Issue</option>
                            </select>

                            <label>Incident Place</label>
                            <textarea id="IncidentPlace" name="IncidentPlace"></textarea>

                            <label>Drop Location</label>
                            <textarea id="DropLocation" name="DropLocation"></textarea>


                            <label>Assign Staff <span style="color:red">*</span></label>
                            <select name="AssignedStaffId" id="AssignedStaffId" required>
                                <option value="">-- Select Staff --</option>
                                @foreach (var s in ViewBag.StaffList)
                                {
                                    <option value="@s.StaffId">@s.StaffName</option>
                                }
                            </select>

                            <div class="actions">
                                <button type="button" class="btn-primary" onclick="saveCase()">Save Case</button>
                                <button type="button" class="btn-secondary" onclick="clearForm()">Clear</button>
                            </div>

                        </form>

                    </div>
                </div>

            </div>
        </div>
    </div>

  
    <script>
        async function parseMessage() {

            const rawMessage = document.getElementById("rawMessage");
            const msg = rawMessage.value.trim();

            if (!msg) {
                alert("⚠️ Please paste a message first");
                rawMessage.focus();
                return;
            }

            try {
                const res = await fetch('/Case/ParseMessage', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ rawMessage: msg })
                });

                if (!res.ok) {
                    alert("❌ Server error while parsing");
                    return;
                }

                const data = await res.json();

                // 🔒 SAFETY CHECK
                if (!Array.isArray(data) || data.length === 0) {
                    alert("❌ No case detected. Please fill manually.");
                    return;
                }

                // ✅ TAKE FIRST CASE ONLY
                const d = data[0];

                // 🔹 BASIC DETAILS
                document.getElementById("CaseId").value = d.caseId || "";
                document.getElementById("CustomerName").value = d.customerName || "";
                document.getElementById("VehicleBrand").value = d.vehicleBrand || "";
                document.getElementById("Model").value = d.model || "";
                document.getElementById("RegistrationNo").value = d.registrationNo || "";
                document.getElementById("ChassisNo").value = d.chassisNo || "";
                document.getElementById("CustomerContactNumber").value = d.customerContactNumber || "";

                // 🔹 INCIDENT DETAILS
                document.getElementById("IncidentReason").value = d.incidentReason || "";
                document.getElementById("IncidentPlace").value = d.incidentPlace || "";
                document.getElementById("DropLocation").value = d.dropLocation || "";

                // 🔹 VENDOR / TOWING
                document.getElementById("AssignedVendorName").value = d.assignedVendorName || "";
                document.getElementById("VendorContactNumber").value = d.vendorContactNumber || "";
                document.getElementById("TowingType").value = d.towingType || "";

                // ✅ UX IMPROVEMENT
                document.getElementById("CaseId").focus();

            } catch (err) {
                console.error(err);
                alert("❌ Failed to parse message");
            }
        }

           async function saveCase() {

            if (!AssignedStaffId.value) {
                alert("⚠️ Please assign a staff member before saving.");
                AssignedStaffId.focus();
                return;
            }

            const form = document.getElementById("caseForm");
            const formData = new FormData(form);

            const res = await fetch('/Case/Create', {
                method: 'POST',
                body: formData
            });

            const result = await res.text();

            if (result.includes("✅")) {
                alert("✅ Case saved successfully");
                form.reset();
                rawMessage.value = "";
            } else {
                alert(result);
            }
        }

        function clearForm() {
            caseForm.reset();
        }
                function clearParser() {
            rawMessage.value = "";
            rawMessage.focus();
        }
    </script>

</body>
</html>
